name: Deploy Flask App with Docker (No Docker Hub)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: SSH and Deploy on Remote Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: ${{ secrets.PORT }}
        script: |
          # Ensure Docker is installed
          docker --version || curl -fsSL https://get.docker.com | sh

          # Clean old app if exists
          sudo rm -rf flaskapp || true
          git clone https://github.com/Syedmujtaba2002/docker_python_flask-project.git flaskapp
          cd flaskapp

          # Stop and remove old container
          docker stop flaskapp || true
          docker rm flaskapp || true

          # Build and run the Docker container
          docker build -t flaskapp .
          docker run -d --name flaskapp -p 5000:5000 flaskapp

